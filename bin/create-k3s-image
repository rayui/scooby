#!/bin/bash
AUTOMOUNTDIR=/media/ray
IMGPATH=/home/ray/Code/scooby/images/rpi-cloud-init-raspios-bullseye-arm64.img
IMGMOUNT=${AUTMOUNTDIR}/rpi-mount
BOOTFSPATH=${AUTMOUNTDIR}/rpi-k3s-boot
ROOTFSPATH=${AUTMOUNTDIR}/rpi-k3s-rootfs
OUTDEV=$1

if [[ ! ${OUTDEV} ]]; then
	echo "First argument must be device path"
	exit 1
fi

#COPY IMAGE TO OUTPUT DEVICE 
dd if=${IMGPATH} of=${OUTDEV} bs=1M status=progress

#RESIZE ROOTFS PARTITION
ROOTPARTSTART=$(sfdisk -l ${OUTDEV} | grep ${OUTDEV}2 | awk '{ print $2 }')
sfdisk --delete ${OUTDEV} 2
sfdisk -a ${OUTDEV} <<EOF
${ROOTPARTSTART},
EOF
resize2fs -f ${OUTDEV}2 20G

#COPY BOOT FILES TO SERVER INSALL
mkdir -p ${BOOTFSPATH}
mkdir -p ${ROOTFSPATH}
mkdir -p ${IMGMOUNT}
umount ${BOOTFSPATH}
umount ${ROOTFSPATH}
mount ${OUTDEV}1 ${BOOTFSPATH}
mount ${OUTDEV}2 ${ROOTFSPATH}

cp -r ./config/server/boot/* ${BOOTFSPATH}
cp -r ./config/server/* ${ROOTFSPATH}
sed -i '$s/$/ cgroup_enable=cpuset cgroup_memory=1 cgroup_enable=memory/' ${BOOTFSPATH}/cmdline.txt

#UNPACK WILLOW INSTALL FROM IMAGE

mkdir -p ${ROOTFSPATH}/var/lib/scooby/agents/willow/
mount -o loop,offset=272629760 ${IMGPATH} ${IMGMOUNT}
rsync -xa --progress ${IMGMOUNT}/* ${ROOTFSPATH}/var/lib/scooby/agents/willow/
umount ${IMGMOUNT}

mkdir -p ${ROOTFSPATH}/var/lib/scooby/agents/willow/boot/
mount -o loop,offset=4194304 ${IMGPATH} ${IMGMOUNT}
rsync -xa --progress ${IMGMOUNT}/* ${ROOTFSPATH}/var/lib/scooby/agents/willow/boot/
umount ${IMGMOUNT}

#CONFIGURE WILLOW IMAGE

cp -r ./config/agents/willow/* ${ROOTFSPATH}/var/lib/scooby/agents/willow/

umount ${BOOTFSPATH}
umount ${ROOTFSPATH}
